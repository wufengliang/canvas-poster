"use strict";var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};var e=function(){return e=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},e.apply(this,arguments)};function n(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}c((r=r.apply(t,e||[])).next())}))}function r(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}}"function"==typeof SuppressedError&&SuppressedError;var o=function(o){function i(t){return o.call(this,t)||this}return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}(i,o),Object.defineProperty(i.prototype,"ctx",{get:function(){var t;return this.context=null!==(t=this.context)&&void 0!==t?t:this.options.element.getContext("2d")},enumerable:!1,configurable:!0}),i.prototype.getRenderImageInstance=function(t){return n(this,void 0,void 0,(function(){var e;return r(this,(function(n){return e=this.options.element,[2,new Promise((function(n){var r=e.createImage();r.src=t,r.onload=function(){return n(r)}}))]}))}))},i.prototype.setTextStyle=function(t){var n=this.ctx,r=this.defaultFontFamlily,o=t.fontSize,i=void 0===o?12:o,a=t.fontFamlily,s=void 0===a?r:a,c=t.color,u=void 0===c?"#000":c,l=t.style,f=void 0===l?{}:l;for(var h in n.font="".concat(i,"px ").concat(s),n.fillStyle=u,n.fillStyle=u,f)h in n&&(n[h]=f[h]);return e(e({},t),{fontSize:i,fontFamlily:s,color:u,style:f})},i}(function(){function t(t){this.positionMap={},this.defaultFontFamlily="sans-serif",this.options=t,this.init()}return Object.defineProperty(t.prototype,"ctx",{get:function(){var t;return this.context=null!==(t=this.context)&&void 0!==t?t:this.options.element.getContext("2d")},enumerable:!1,configurable:!0}),t.prototype.init=function(){this.validator(),this.setDefaultFamlily(),this.initElement()},t.prototype.validator=function(){var t=this.options,e=t.width,n=t.height;if(!this.ctx)throw new Error("请确认canvas节点是否存在");if(!e||!n)throw new Error("请设置canvas的宽高度")},t.prototype.setDefaultFamlily=function(){},t.prototype.initElement=function(){var t=this.options,e=t.element,n=t.width,r=t.height;e.width=n,e.height=r,this.render()},t.prototype.render=function(){return n(this,void 0,void 0,(function(){var t,e,n;return r(this,(function(r){switch(r.label){case 0:t=null,e=0,r.label=1;case 1:return(t=this.options.dataSource.shift())?[4,this.renderItem(t,++e)]:[3,3];case 2:return r.sent(),[3,1];case 3:return(n=this.options.success)&&n(this.options.element),[2]}}))}))},t.prototype.renderItem=function(t,o){return n(this,void 0,void 0,(function(){var n,i,a,s,c,u,l,f,h,p,d,y,v,w;return r(this,(function(r){switch(r.label){case 0:switch(n=t.type,i=t.value,a=i.x,s=void 0===a?0:a,c=i.y,u=void 0===c?0:c,l=i.fixed,f=void 0!==l&&l,h=i.parentId,p=void 0===h?"":h,d=i.id,y=void 0===d?"".concat(o):d,f&&(v=this.positionMap[p],s+=v?v.x:0,u+=v?v.y:0),w=e(e({},i),{x:s,y:u,fixed:f,parentId:p,id:y}),n){case"image":return[3,1];case"text":return[3,3]}return[3,5];case 1:return[4,this.renderImage(w)];case 2:case 4:return r.sent(),[3,6];case 3:return[4,this.renderText(w)];case 5:throw new Error("当前还未适配".concat(n,"类型"));case 6:return[2]}}))}))},t.prototype.renderImage=function(t){return n(this,void 0,void 0,(function(){var n,o,i,a,s,c,u,l,f;return r(this,(function(r){switch(r.label){case 0:if(n=t.r,o=void 0===n?0:n,i=t.width,a=t.height,s=t.id,c=t.x,u=t.y,o>0&&(o!==i/2||o!==a/2))throw new Error("当前传入的半径值不到宽或高的一半,无法绘制圆形");return[4,this.getRenderImageInstance(t.value)];case 1:return l=r.sent(),f=e(e({},t),{value:l}),o?this.drawCircleImage(f):this.drawNormalImage(f),this.positionMap[s]={x:c,y:u},[2]}}))}))},t.prototype.renderText=function(t){return n(this,void 0,void 0,(function(){var n,o,i,a,s,c,u,l,f,h,p,d,y;return r(this,(function(r){return o=(n=this).ctx,i=n.defaultFontFamlily,a=t.fontSize,s=void 0===a?12:a,c=t.fontFamlily,u=void 0===c?i:c,t.color,t.style,l=t.value,f=t.x,h=t.y,p=t.id,d=this.setTextStyle(e(e({},t),{fontSize:s,fontFamlily:u})),y=h+d.fontSize,o.fillText(l,f,y),this.positionMap[p]={x:f,y},[2]}))}))},t.prototype.drawCircleImage=function(t){var e=this.ctx,n=t.x,r=t.y,o=t.width,i=t.height,a=t.value;t.id;var s=n+o/2,c=r+i/2,u=Math.min(s,c);e.save(),e.beginPath(),e.arc(s,c,u,0,2*Math.PI),e.clip(),e.drawImage(a,s-u,c-u,2*u,2*u),e.restore()},t.prototype.drawNormalImage=function(t){var e=this.ctx,n=t.x,r=t.y,o=t.width,i=t.height,a=t.value;t.id,e.save(),e.beginPath(),e.drawImage(a,n,r,o,i),e.restore()},t}());exports.MiniCanvasInstance=o;
